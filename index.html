<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Investing</title>
<style>
:root{--bg:#1E1F23;--bg2:#27282D;--surface:#2C2D33;--text:#FFFFFF;--text2:#9DA0A6;--text3:#6B6E75;--green:#00C805;--red:#FF5000;--separator:rgba(255,255,255,0.06)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;-webkit-font-smoothing:antialiased;padding-bottom:80px;max-width:500px;margin:0 auto}
.screen{padding:0 16px}

/* Top bar */
.top-bar{padding:env(safe-area-inset-top,20px) 16px 0;position:sticky;top:0;z-index:100;background:var(--bg)}
.top-label{font-size:13px;color:var(--text2);font-weight:400;margin-bottom:2px}
.portfolio-value{font-size:36px;font-weight:800;letter-spacing:-1px;font-variant-numeric:tabular-nums}
.portfolio-change{font-size:14px;font-weight:500;margin-top:2px;font-variant-numeric:tabular-nums}
.portfolio-change.up{color:var(--green)}
.portfolio-change.down{color:var(--red)}

/* Chart area */
.chart-area{height:200px;margin:20px 0 8px;position:relative;overflow:hidden;touch-action:none;cursor:crosshair;-webkit-user-select:none;user-select:none}
.chart-canvas{position:absolute;top:0;left:0;width:100%;height:100%}
.chart-crosshair{position:absolute;top:0;width:1px;height:100%;background:rgba(255,255,255,0.3);pointer-events:none;display:none}
.chart-dot{position:absolute;width:8px;height:8px;border-radius:50%;pointer-events:none;display:none;transform:translate(-50%,-50%);border:2px solid var(--bg)}
.chart-time-label{position:absolute;top:4px;background:var(--surface);color:var(--text2);font-size:11px;padding:2px 8px;border-radius:8px;pointer-events:none;display:none;white-space:nowrap;transform:translateX(-50%)}
.chart-building{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:var(--text3);font-size:14px}
.time-buttons{display:flex;gap:0;padding:4px 0 16px}
.time-btn{flex:1;text-align:center;font-size:12px;font-weight:600;color:var(--text3);padding:6px 0;border:none;background:none;cursor:pointer;border-radius:16px;transition:all .2s}
.time-btn.active{color:var(--green);background:rgba(0,200,5,0.1)}

/* Separator */
.sep{height:1px;background:var(--separator);margin:0 -16px}

/* Section row */
.row{display:flex;justify-content:space-between;align-items:center;padding:16px 0}
.row-label{font-size:15px;color:var(--text);font-weight:400}
.row-value{font-size:15px;font-weight:600;font-variant-numeric:tabular-nums}

/* Bot status */
.bot-row{display:flex;align-items:center;padding:14px 0;gap:10px}
.bot-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.bot-dot.on{background:var(--green);box-shadow:0 0 6px var(--green)}
.bot-dot.off{background:var(--text3)}
.bot-name{font-size:15px;font-weight:500;flex:1}
.bot-name span{color:var(--text3);font-weight:400}
.bot-bal{font-size:15px;font-weight:600;font-variant-numeric:tabular-nums}

/* Section headers */
.section-header{display:flex;justify-content:space-between;align-items:baseline;padding:24px 0 8px}
.section-title{font-size:18px;font-weight:700}
.section-count{font-size:14px;color:var(--text3);font-weight:400}

/* Position rows */
.pos-row{display:flex;align-items:center;padding:12px 0;cursor:pointer}
.pos-left{flex:1;min-width:0}
.pos-name{font-size:15px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:flex;align-items:center;gap:8px}
.pos-badge{font-size:10px;font-weight:700;padding:2px 6px;border-radius:4px;letter-spacing:.3px;flex-shrink:0}
.pos-badge.apex{background:rgba(59,130,246,0.15);color:#60A5FA}
.pos-badge.meridian{background:rgba(0,200,5,0.12);color:var(--green)}
.pos-sub{font-size:12px;color:var(--text3);margin-top:2px}
.pos-right{text-align:right;flex-shrink:0;margin-left:12px}
.pos-val{font-size:15px;font-weight:600;font-variant-numeric:tabular-nums}
.pos-pct{font-size:12px;font-weight:500;margin-top:1px;font-variant-numeric:tabular-nums}
.pos-pct.up{color:var(--green)}
.pos-pct.down{color:var(--red)}

/* Group expand */
.group-children{overflow:hidden;max-height:0;transition:max-height .3s ease}
.group-children.open{max-height:2000px}
.group-children .pos-row{padding-left:16px;opacity:0.8}

/* Activity */
.activity-row{padding:12px 0}
.activity-text{font-size:14px;color:var(--text);line-height:1.4}
.activity-text .dim{color:var(--text3)}

/* Crypto watchlist */
.crypto-row{display:flex;align-items:center;padding:12px 0}
.crypto-sym{font-size:15px;font-weight:600;width:56px}
.crypto-name{font-size:12px;color:var(--text3);flex:1}
.crypto-price{font-size:15px;font-weight:600;font-variant-numeric:tabular-nums;text-align:right;margin-right:12px}
.crypto-chg{font-size:13px;font-weight:500;width:64px;text-align:right;font-variant-numeric:tabular-nums}
.crypto-chg.up{color:var(--green)}
.crypto-chg.down{color:var(--red)}

/* Bottom nav */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--bg);border-top:1px solid var(--separator);display:flex;justify-content:space-around;padding:8px 0 env(safe-area-inset-bottom,8px);z-index:200;max-width:500px;margin:0 auto}
.nav-item{display:flex;flex-direction:column;align-items:center;gap:2px;font-size:10px;color:var(--text3);padding:4px 12px;cursor:pointer}
.nav-item.active{color:var(--text)}
.nav-item svg{width:22px;height:22px;fill:currentColor}

/* Scrollable sections */
.nav-section{display:none}
.nav-section.active{display:block}

/* Trades tab */
.trade-row{padding:12px 0}
.trade-main{font-size:14px;font-weight:500;display:flex;align-items:center;gap:6px}
.trade-action{font-size:11px;font-weight:700;padding:2px 6px;border-radius:4px}
.trade-action.buy{background:rgba(0,200,5,0.12);color:var(--green)}
.trade-action.sell{background:rgba(255,80,0,0.12);color:var(--red)}
.trade-detail{font-size:12px;color:var(--text3);margin-top:2px}
.trade-status{font-size:10px;font-weight:600;padding:2px 6px;border-radius:4px;margin-left:auto}
.trade-status.placed{background:rgba(0,200,5,0.12);color:var(--green)}
.trade-status.submitted{background:rgba(59,130,246,0.15);color:#60A5FA}
.trade-status.error{background:rgba(255,80,0,0.12);color:var(--red)}
.trade-status.dry_run{background:rgba(255,255,255,0.06);color:var(--text3)}

@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.fade-in{animation:fadeIn .3s ease forwards}
</style>
</head>
<body>

<div class="top-bar">
  <div class="top-label">Investing</div>
  <div class="portfolio-value" id="totalValue">—</div>
  <div class="portfolio-change" id="totalChange"></div>
</div>

<div class="screen">
  <!-- Chart -->
  <div class="chart-area" id="chartArea">
    <canvas class="chart-canvas" id="chartCanvas"></canvas>
    <div class="chart-crosshair" id="chartCrosshair"></div>
    <div class="chart-dot" id="chartDot"></div>
    <div class="chart-time-label" id="chartTimeLabel"></div>
  </div>
  <div class="time-buttons">
    <button class="time-btn active">1D</button>
    <button class="time-btn">1W</button>
    <button class="time-btn">1M</button>
    <button class="time-btn">ALL</button>
  </div>

  <!-- NAV SECTIONS -->
  <div id="sec-portfolio" class="nav-section active">
    <div class="sep"></div>
    <div class="row"><span class="row-label">Buying Power</span><span class="row-value" id="buyingPower">—</span></div>
    <div class="sep"></div>

    <!-- Bot status -->
    <div id="botStatus"></div>
    <div class="sep"></div>

    <!-- Positions -->
    <div class="section-header">
      <span class="section-title">Positions</span>
      <span class="section-count" id="posCount"></span>
    </div>
    <div id="positions"></div>
    <div class="sep" style="margin-top:8px"></div>

    <!-- Recent Activity -->
    <div class="section-header"><span class="section-title">Recent Activity</span></div>
    <div id="activity"></div>
    <div class="sep" style="margin-top:8px"></div>

    <!-- Crypto -->
    <div class="section-header"><span class="section-title">Crypto</span></div>
    <div id="crypto"></div>
    <div style="height:24px"></div>
  </div>

  <div id="sec-positions" class="nav-section">
    <div class="section-header"><span class="section-title">All Positions</span><span class="section-count" id="posCount2"></span></div>
    <div id="positionsAll"></div>
  </div>

  <div id="sec-trades" class="nav-section">
    <div class="section-header"><span class="section-title">Recent Trades</span></div>
    <div id="tradesAll"></div>
  </div>

  <div id="sec-markets" class="nav-section">
    <div class="section-header"><span class="section-title">Market Data</span></div>
    <div id="cryptoFull"></div>
  </div>
</div>

<!-- Bottom Nav -->
<div class="bottom-nav">
  <div class="nav-item active" data-sec="portfolio">
    <svg viewBox="0 0 24 24"><path d="M3 13h1v7h4v-5h4v5h4v-7h1l-7-7-7 7z"/><path d="M10 2v2h4V2h-4z" fill="none"/></svg>
    Portfolio
  </div>
  <div class="nav-item" data-sec="positions">
    <svg viewBox="0 0 24 24"><path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/></svg>
    Positions
  </div>
  <div class="nav-item" data-sec="trades">
    <svg viewBox="0 0 24 24"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>
    Trades
  </div>
  <div class="nav-item" data-sec="markets">
    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
    Markets
  </div>
</div>

<script>
const TM={KXBTC:'Bitcoin',KXBTCD:'Bitcoin',KXETH:'Ethereum',KXETHD:'Ethereum',KXSOL:'Solana',KXSOLD:'Solana',KXXRP:'XRP',KXXRPD:'XRP',KXDOGE:'Dogecoin',KXDOGED:'Dogecoin',KXRECSSNBER:'Recession 2026',KXLARGECUT:'Fed Large Rate Cut',KXAISPIKE:'AI Capability Growth',KXCABLEAVE:'Trump Cabinet Leave',KXFEDMEET:'Fed Emergency Meeting',KXINXPOS:"S&P Positive 2026",KXWARSHNOM:'Warren Sherman Nom.'};

function getAssetGroup(ticker){
  const m=ticker.match(/^(KX[A-Z]+D?)-/);
  if(!m)return null;
  const isRange=ticker.match(/-B\d/);
  if(isRange)return m[1]+'-RANGE';
  return null;
}

function parseTicker(t){
  const m=t.match(/^(KX[A-Z]+D?)/);if(!m)return t;
  const p=m[1],name=TM[p]||p;
  const r=t.match(/B(\d+\.?\d*)/);
  if(r){const v=parseFloat(r[1]);
    if(p.includes('XRP'))return name+' $'+v.toFixed(2)+'–$'+(v+.01).toFixed(2);
    if(p.includes('BTC')||p.includes('ETH'))return name+' $'+Math.round(v).toLocaleString()+' range';
    return name+' $'+v+' range';}
  const th=t.match(/T(\d+\.?\d*)/);
  if(th){const v=parseFloat(th[1]);
    if(p.includes('BTC'))return name+' above $'+Math.round(v).toLocaleString();
    if(p.includes('ETH'))return name+' above $'+Math.round(v).toLocaleString();
    if(p.includes('XRP'))return name+' above $'+v.toFixed(2);
    if(p.includes('SOL'))return name+' above $'+Math.round(v);
    return name+' above '+v;}
  return name;
}

const $=id=>document.getElementById(id);
const fmt=(n,d=2)=>{if(n==null)return'—';const v=Number(n);return(v<0?'-':'')+'\$'+Math.abs(v).toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d});};
function isActive(ts){if(!ts)return false;const now=Date.now()/1000;const t=ts>1e12?ts/1000:ts;return(now-t)<7200}

// Nav switching
document.querySelectorAll('.nav-item').forEach(el=>{
  el.addEventListener('click',()=>{
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    document.querySelectorAll('.nav-section').forEach(s=>s.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('sec-'+el.dataset.sec).classList.add('active');
  });
});

// History chart
let historyData=null,filteredData=null,currentPeriod='ALL',isScrubbing=false;
let savedTotalValue=0,savedTotalPnl=0,savedTotalPct=0,savedPnlPositive=true;

async function loadHistory(){
  try{const r=await fetch('/history.json?'+Date.now());historyData=await r.json();filterHistory()}catch(e){historyData=null;drawChart()}
}

function filterHistory(){
  if(!historyData||!historyData.timestamps.length){filteredData=null;drawChart();return}
  const now=Date.now();
  const periods={
    '1D':now-86400000,'1W':now-7*86400000,'1M':now-30*86400000,'ALL':0
  };
  const cutoff=periods[currentPeriod]||0;
  const ts=historyData.timestamps,vs=historyData.values;
  const ft=[],fv=[];
  for(let i=0;i<ts.length;i++){if(ts[i]>=cutoff){ft.push(ts[i]);fv.push(vs[i])}}
  filteredData=ft.length>=2?{timestamps:ft,values:fv}:null;
  drawChart();
}

function drawChart(){
  const canvas=$('chartCanvas'),area=$('chartArea');
  const dpr=window.devicePixelRatio||1;
  const w=area.clientWidth,h=area.clientHeight;
  canvas.width=w*dpr;canvas.height=h*dpr;
  canvas.style.width=w+'px';canvas.style.height=h+'px';
  const ctx=canvas.getContext('2d');
  ctx.scale(dpr,dpr);ctx.clearRect(0,0,w,h);

  if(!filteredData||filteredData.values.length<3){
    ctx.fillStyle='#6B6E75';ctx.font='14px -apple-system,sans-serif';ctx.textAlign='center';
    ctx.fillText('Building history — updates every 5 min',w/2,h/2-10);
    ctx.font='12px -apple-system,sans-serif';ctx.fillStyle='#3E4046';
    ctx.fillText('Chart will populate as data accumulates',w/2,h/2+12);return;
  }

  const vs=filteredData.values;
  const mn=Math.min(...vs),mx=Math.max(...vs);
  const range=mx-mn||1;const pad=10;
  const positive=vs[vs.length-1]>=vs[0];
  const color=positive?'#00C805':'#FF5000';

  // Build points
  const pts=[];
  for(let i=0;i<vs.length;i++){
    const x=(i/(vs.length-1))*w;
    const y=pad+(1-(vs[i]-mn)/range)*(h-2*pad);
    pts.push([x,y]);
  }

  // Area fill gradient
  const grad=ctx.createLinearGradient(0,0,0,h);
  grad.addColorStop(0,positive?'rgba(0,200,5,0.25)':'rgba(255,80,0,0.25)');
  grad.addColorStop(1,positive?'rgba(0,200,5,0)':'rgba(255,80,0,0)');
  ctx.beginPath();ctx.moveTo(pts[0][0],pts[0][1]);
  for(let i=1;i<pts.length;i++)ctx.lineTo(pts[i][0],pts[i][1]);
  ctx.lineTo(w,h);ctx.lineTo(0,h);ctx.closePath();
  ctx.fillStyle=grad;ctx.fill();

  // Line
  ctx.beginPath();ctx.moveTo(pts[0][0],pts[0][1]);
  for(let i=1;i<pts.length;i++)ctx.lineTo(pts[i][0],pts[i][1]);
  ctx.strokeStyle=color;ctx.lineWidth=2;ctx.lineJoin='round';ctx.stroke();
}

function getChartIndex(clientX){
  if(!filteredData)return -1;
  const rect=$('chartArea').getBoundingClientRect();
  const x=clientX-rect.left;
  const ratio=Math.max(0,Math.min(1,x/rect.width));
  return Math.round(ratio*(filteredData.values.length-1));
}

function startScrub(clientX){
  if(!filteredData||filteredData.values.length<2)return;
  isScrubbing=true;updateScrub(clientX);
}
function updateScrub(clientX){
  if(!isScrubbing||!filteredData)return;
  const idx=getChartIndex(clientX);if(idx<0)return;
  const val=filteredData.values[idx],ts=filteredData.timestamps[idx];
  const first=filteredData.values[0];
  const change=val-first,pct=first>0?(change/first*100):0;

  $('totalValue').textContent=fmt(val);
  const cls=change>=0?'up':'down';
  $('totalChange').className='portfolio-change '+cls;
  $('totalChange').textContent=(change>=0?'+':'')+fmt(change)+' ('+(change>=0?'+':'')+pct.toFixed(2)+'%)';

  // Crosshair
  const rect=$('chartArea').getBoundingClientRect();
  const x=clientX-rect.left;
  const ch=$('chartCrosshair'),dot=$('chartDot'),lbl=$('chartTimeLabel');
  ch.style.display='block';ch.style.left=x+'px';

  // Dot
  const vs=filteredData.values,mn=Math.min(...vs),mx=Math.max(...vs),range=mx-mn||1,pad=10,h=rect.height;
  const y=pad+(1-(val-mn)/range)*(h-2*pad);
  const positive=vs[vs.length-1]>=vs[0];
  dot.style.display='block';dot.style.left=x+'px';dot.style.top=y+'px';
  dot.style.background=positive?'var(--green)':'var(--red)';

  // Time label
  const d=new Date(ts);
  const timeStr=d.toLocaleDateString('en-US',{month:'short',day:'numeric'})+' '+d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true});
  lbl.style.display='block';
  lbl.style.left=Math.max(40,Math.min(rect.width-40,x))+'px';
  lbl.textContent=timeStr;
}
function endScrub(){
  if(!isScrubbing)return;
  isScrubbing=false;
  $('chartCrosshair').style.display='none';
  $('chartDot').style.display='none';
  $('chartTimeLabel').style.display='none';
  // Restore current values
  $('totalValue').textContent=fmt(savedTotalValue);
  const cls=savedPnlPositive?'up':'down';
  $('totalChange').className='portfolio-change '+cls;
  $('totalChange').textContent=(savedPnlPositive?'+':'')+fmt(savedTotalPnl)+' ('+(savedPnlPositive?'+':'')+savedTotalPct.toFixed(2)+'%) All time';
}

// Chart touch/mouse events
const ca=$('chartArea');
ca.addEventListener('mousedown',e=>{e.preventDefault();startScrub(e.clientX)});
window.addEventListener('mousemove',e=>{if(isScrubbing){e.preventDefault();updateScrub(e.clientX)}});
window.addEventListener('mouseup',endScrub);
ca.addEventListener('touchstart',e=>{e.preventDefault();startScrub(e.touches[0].clientX)},{passive:false});
ca.addEventListener('touchmove',e=>{e.preventDefault();updateScrub(e.touches[0].clientX)},{passive:false});
ca.addEventListener('touchend',endScrub);

// Time button switching
document.querySelectorAll('.time-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.time-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    currentPeriod=btn.textContent.trim();
    filterHistory();
  });
});

loadHistory();setInterval(loadHistory,300000);

// Crypto
const SYMS=['BTCUSDT','ETHUSDT','SOLUSDT','XRPUSDT','DOGEUSDT'];
const NAMES={BTCUSDT:['BTC','Bitcoin'],ETHUSDT:['ETH','Ethereum'],SOLUSDT:['SOL','Solana'],XRPUSDT:['XRP','XRP'],DOGEUSDT:['DOGE','Dogecoin']};
let cryptoData={};

async function fetchCrypto(){
  const urls=['https://api.binance.com/api/v3/ticker/24hr?symbols='+encodeURIComponent(JSON.stringify(SYMS)),
              'https://api.binance.us/api/v3/ticker/24hr?symbols='+encodeURIComponent(JSON.stringify(SYMS))];
  for(const url of urls){
    try{
      const r=await fetch(url);if(!r.ok)continue;
      const data=await r.json();
      data.forEach(t=>{
        const [sym,name]=NAMES[t.symbol];
        cryptoData[sym]={price:parseFloat(t.lastPrice),pct:parseFloat(t.priceChangePercent),name};
      });
      renderCrypto();return;
    }catch(e){}
  }
}

function renderCrypto(){
  const html=Object.entries(cryptoData).map(([sym,d])=>{
    const pFmt=d.price>=100?'$'+Math.round(d.price).toLocaleString():'$'+d.price.toFixed(d.price>=1?2:4);
    const cls=d.pct>=0?'up':'down';
    return `<div class="crypto-row">
      <span class="crypto-sym">${sym}</span>
      <span class="crypto-name">${d.name}</span>
      <span class="crypto-price">${pFmt}</span>
      <span class="crypto-chg ${cls}">${d.pct>=0?'+':''}${d.pct.toFixed(2)}%</span>
    </div>`;
  }).join('');
  $('crypto').innerHTML=html;
  $('cryptoFull').innerHTML=html;
}

fetchCrypto();setInterval(fetchCrypto,15000);

async function loadData(){try{const r=await fetch('/data.json?'+Date.now());renderData(await r.json())}catch(e){}}

function renderData(data){
  const o=data.overview||{},apex=o.apex||{},mer=o.meridian||{},pos=data.positions||{},trades=(data.trades||{}).trades||[];

  const merCash=(mer.balance||0)/100;
  const merPortValue=(mer.portfolio_value||0)/100;
  const merTotal=merCash+merPortValue;
  const merStarting=4090;
  const allMerPositions=mer.positions||pos.meridian||[];
  const merPos=allMerPositions.filter(p=>p.position>0);
  const merPnl=merTotal-merStarting;
  const ap=apex.pnl||{};
  const apexBal=apex.total_invested||0;
  const totalPortfolio=merTotal+apexBal;
  const totalPnl=merPnl+(ap.realized_pnl||0);
  const totalPct=totalPortfolio>0?(totalPnl/(totalPortfolio-totalPnl)*100):0;

  // Top bar
  $('totalValue').textContent=fmt(totalPortfolio);
  const cls=totalPnl>=0?'up':'down';
  $('totalChange').className='portfolio-change '+cls;
  $('totalChange').textContent=(totalPnl>=0?'+':'')+fmt(totalPnl)+' ('+(totalPnl>=0?'+':'')+totalPct.toFixed(2)+'%) All time';

  savedTotalValue=totalPortfolio;savedTotalPnl=totalPnl;savedTotalPct=totalPct;savedPnlPositive=totalPnl>=0;
  if(!isScrubbing)filterHistory();

  // Buying power
  $('buyingPower').textContent=fmt(merCash+Math.max(0,apexBal-(apex.total_invested||0)));

  // Bot status
  $('botStatus').innerHTML=`
    <div class="bot-row">
      <div class="bot-dot ${isActive(apex.last_scan)?'on':'off'}"></div>
      <div class="bot-name">APEX <span>· Polymarket</span></div>
      <div class="bot-bal">${fmt(apexBal)}</div>
    </div>
    <div class="bot-row">
      <div class="bot-dot ${isActive(mer.last_scan)?'on':'off'}"></div>
      <div class="bot-name">MERIDIAN <span>· Kalshi</span></div>
      <div class="bot-bal">${fmt(merTotal)}</div>
    </div>`;

  // Build positions
  const apexPositions=(pos.apex||[]).filter(p=>p.status==='open').map(p=>({
    bot:'apex',market:p.market_question||'Unknown',side:p.side||'YES',
    size:p.size_usdc,contracts:p.num_tokens?Math.round(p.num_tokens):0,
    entry:p.entry_price?(p.entry_price*100).toFixed(1)+'¢':'—',
    pnl:null,pctChange:null,curPrice:null,ticker:''
  }));

  const merPositions=merPos.map(p=>{
    const entryCents=p.position>0?p.market_exposure/p.position:0;
    const curPrice=p.yes_bid||p.last_price||0;
    const unrealizedPnl=p.position>0&&curPrice>0?(curPrice-entryCents)*p.position/100:null;
    const pctChange=entryCents>0&&curPrice>0?((curPrice-entryCents)/entryCents*100):null;
    return {
      bot:'meridian',market:parseTicker(p.ticker),side:'YES',
      size:(p.market_exposure||0)/100,contracts:p.position,
      entry:entryCents>0?entryCents.toFixed(1)+'¢':'—',
      pnl:unrealizedPnl,pctChange,curPrice,ticker:p.ticker
    };
  });

  // Group range bets
  const allPos=[];const groups={};
  apexPositions.forEach(p=>allPos.push(p));
  merPositions.forEach(p=>{
    const gk=getAssetGroup(p.ticker);
    if(gk){
      if(!groups[gk])groups[gk]={positions:[],totalExp:0,totalPnl:0,totalContracts:0,asset:'',totalValue:0};
      groups[gk].positions.push(p);
      groups[gk].totalExp+=p.size;
      groups[gk].totalPnl+=(p.pnl||0);
      groups[gk].totalContracts+=p.contracts;
      if(p.curPrice&&p.contracts)groups[gk].totalValue+=p.curPrice*p.contracts/100;
      const m=gk.match(/^(KX[A-Z]+D?)/);
      groups[gk].asset=TM[m[1]]||m[1];
    } else allPos.push(p);
  });

  const totalCount=apexPositions.length+merPos.length;
  $('posCount').textContent=totalCount;
  $('posCount2').textContent=totalCount+' positions';

  function posRow(p){
    const pctCls=p.pctChange!=null?(p.pctChange>=0?'up':'down'):'';
    const pctStr=p.pctChange!=null?(p.pctChange>=0?'+':'')+p.pctChange.toFixed(2)+'%':'';
    const valStr=fmt(p.size);
    return `<div class="pos-row">
      <div class="pos-left">
        <div class="pos-name">${p.market}<span class="pos-badge ${p.bot}">${p.bot.toUpperCase()}</span></div>
        <div class="pos-sub">${p.contracts} shares · Entry ${p.entry}</div>
      </div>
      <div class="pos-right">
        <div class="pos-val">${valStr}</div>
        ${pctStr?`<div class="pos-pct ${pctCls}">${pctStr}</div>`:''}
      </div>
    </div>`;
  }

  let posHTML='';
  Object.entries(groups).forEach(([gk,g])=>{
    const id='g'+gk.replace(/[^a-z0-9]/gi,'');
    const grpPct=g.totalExp>0&&g.totalValue>0?((g.totalValue-g.totalExp)/g.totalExp*100):null;
    const pctCls=grpPct!=null?(grpPct>=0?'up':'down'):'';
    const pctStr=grpPct!=null?(grpPct>=0?'+':'')+grpPct.toFixed(2)+'%':'';
    posHTML+=`<div class="pos-row" onclick="document.getElementById('${id}').classList.toggle('open')">
      <div class="pos-left">
        <div class="pos-name">${g.asset} Range Bets<span class="pos-badge meridian">MERIDIAN</span></div>
        <div class="pos-sub">${g.positions.length} positions · ${g.totalContracts.toLocaleString()} shares</div>
      </div>
      <div class="pos-right">
        <div class="pos-val">${fmt(g.totalExp)}</div>
        ${pctStr?`<div class="pos-pct ${pctCls}">${pctStr}</div>`:''}
      </div>
    </div>
    <div class="group-children" id="${id}">${g.positions.map(posRow).join('')}</div>`;
  });
  allPos.forEach(p=>posHTML+=posRow(p));

  $('positions').innerHTML=posHTML||'<div style="padding:20px 0;color:var(--text3);font-size:14px">No open positions</div>';
  $('positionsAll').innerHTML=posHTML;

  // Recent Activity (trades)
  const rt=trades.filter(t=>t.timestamp).slice(0,8);
  $('activity').innerHTML=rt.length===0?'<div style="padding:16px 0;color:var(--text3);font-size:14px">No recent activity</div>':
    rt.map(t=>{
      const time=new Date(t.timestamp);
      const ts=time.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true,timeZone:'UTC'});
      const act=(t.action||'').toUpperCase();
      const isBuy=act.includes('BUY')||act.includes('PLACE');
      const mkt=t.market||parseTicker(t.ticker||'');
      const sz=t.size_usdc?fmt(t.size_usdc):t.cost_cents?fmt(t.cost_cents/100):'';
      return `<div class="activity-row">
        <div class="activity-text">${isBuy?'Bought':'Sold'} ${mkt} <span class="dim">· ${sz} · ${ts}</span></div>
      </div>`;
    }).join('');

  // Full trades list
  $('tradesAll').innerHTML=trades.filter(t=>t.timestamp).slice(0,30).map(t=>{
    const time=new Date(t.timestamp);
    const ts=time.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true,timeZone:'UTC'});
    const act=(t.action||'').toUpperCase();
    const isBuy=act.includes('BUY')||act.includes('PLACE');
    const mkt=t.market||parseTicker(t.ticker||'');
    const sz=t.size_usdc?fmt(t.size_usdc):t.cost_cents?fmt(t.cost_cents/100):'';
    const st=t.status||'unknown';
    const pr=t.price!=null&&t.price<10?(t.price<1?(t.price*100).toFixed(0)+'¢':t.price):t.price_cents?t.price_cents+'¢':'';
    return `<div class="trade-row">
      <div class="trade-main">
        <span class="trade-action ${isBuy?'buy':'sell'}">${isBuy?'BUY':'SELL'}</span>
        ${mkt}
        <span class="trade-status ${st}">${st==='dry_run'?'DRY':st.toUpperCase()}</span>
      </div>
      <div class="trade-detail">${sz}${pr?' @ '+pr:''} · ${ts}</div>
    </div>`;
  }).join('')||'<div style="padding:16px 0;color:var(--text3)">No trades yet</div>';
}

loadData();setInterval(loadData,60000);
</script>
</body>
</html>